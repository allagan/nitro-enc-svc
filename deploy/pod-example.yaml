apiVersion: v1
kind: Pod
metadata:
  name: my-app
  namespace: default
spec:
  containers:
    # -------------------------------------------------------------------------
    # Main application container
    # -------------------------------------------------------------------------
    - name: app
      image: my-app:latest
      ports:
        - containerPort: 8080
      env:
        # Sends outbound requests to the vsock-proxy sidecar, which forwards
        # them to the enclave for PII encryption before calling downstream.
        - name: ENCRYPTION_ENDPOINT
          value: "https://127.0.0.1:8443"

    # -------------------------------------------------------------------------
    # vsock-proxy sidecar
    # -------------------------------------------------------------------------
    - name: vsock-proxy
      image: placeholder/vsock-proxy:latest  # Replace with real ECR image
      ports:
        - containerPort: 8443
      env:
        - name: LISTEN_PORT
          value: "8443"
        - name: ENCLAVE_CID
          value: "16"   # CID of the Nitro Enclave on this node
        - name: ENCLAVE_PORT
          value: "443"
        - name: MAIN_APP_ADDR
          value: "127.0.0.1:8080"
        - name: LOG_LEVEL
          value: "info"
      resources:
        requests:
          cpu: "100m"
          memory: "64Mi"
        limits:
          cpu: "500m"
          memory: "128Mi"
